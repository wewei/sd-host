# SD-Host API Documentation

SD-Host æä¾›äº†ä¸€å¥—å®Œæ•´çš„ RESTful API æ¥ç®¡ç† Stable Diffusion æ¨¡å‹å’Œä¸‹è½½ä»»åŠ¡ã€‚

## API æ¦‚è¿°

- **è®¾è®¡åŸåˆ™**: RESTful æ¶æ„ï¼ŒJSON æ•°æ®äº¤æ¢
- **API å‰ç¼€**: `/api`
- **å®æ—¶é€šä¿¡**: Server-Sent Events (SSE)
- **ç›®æ ‡åœºæ™¯**: å•ç”¨æˆ·æœ¬åœ°éƒ¨ç½²æˆ–å±€åŸŸç½‘ä½¿ç”¨
- **æŸ¥è¯¢ç³»ç»Ÿ**: åŸºäº JSON API æ ‡å‡†çš„å®ä½“æŸ¥è¯¢åè®®

ğŸ“– **æŸ¥è¯¢åè®®è¯¦ç»†æ–‡æ¡£**: [å®ä½“æŸ¥è¯¢åè®® (JSON API)](./entity-query-protocol.md)

ğŸ“Š **æ•°æ®åº“è®¾è®¡æ–‡æ¡£**: [SQLite æ•°æ®åº“è¡¨ç»“æ„](./database-schema.md)

---

## RESTful API è®¾è®¡åŸåˆ™

SD-Host éµå¾ªä»¥ä¸‹ RESTful API è®¾è®¡åŸåˆ™ï¼Œç¡®ä¿ API çš„ä¸€è‡´æ€§å’Œå¯é¢„æµ‹æ€§ï¼š

### 1. å®ä½“åˆ—è¡¨æŸ¥è¯¢ - `GET /{entities}`

- **ç”¨é€”**: ä»…ç”¨äºè·å–å®ä½“åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰æ¡ä»¶æŸ¥è¯¢
- **æ•°æ®æ ¼å¼**: å®ä½“å¯¹è±¡ä»¥**åˆ—è¡¨é¡¹çš„ç®€æ´å½¢å¼**è¡¨è¾¾ï¼ŒåŒ…å«æ ¸å¿ƒå­—æ®µ
- **ç¤ºä¾‹**: `GET /api/models` - è·å–æ¨¡å‹åˆ—è¡¨ï¼Œæ¯ä¸ªæ¨¡å‹åŒ…å«åŸºæœ¬ä¿¡æ¯å¦‚ hashã€nameã€type ç­‰

### 2. å®ä½“è¯¦æƒ…è·å– - `GET /{entities}/{entity-id}`

- **ç”¨é€”**: ä»…ç”¨äºè·å–å•ä¸ªå®ä½“çš„è¯¦ç»†ä¿¡æ¯
- **æ•°æ®æ ¼å¼**: è¿”å›å®ä½“å¯¹è±¡çš„**å®Œæ•´å½¢å¼ JSON**ï¼ŒåŒ…å«æ‰€æœ‰è¯¦ç»†å­—æ®µ
- **ç¤ºä¾‹**: `GET /api/models/{hash}` - è·å–æŒ‡å®šæ¨¡å‹çš„å®Œæ•´å…ƒæ•°æ®

### 3. å®ä½“åˆ é™¤ - `DELETE /{entities}/{entity-id}`

- **ç”¨é€”**: ç”¨äºåˆ é™¤æŒ‡å®šçš„å•ä¸ªå®ä½“
- **æ ‡å‡†æ“ä½œ**: ä½¿ç”¨æ ‡å‡†çš„ HTTP DELETE æ–¹æ³•
- **ç¤ºä¾‹**: `DELETE /api/models/{hash}` - åˆ é™¤æŒ‡å®šçš„æ¨¡å‹

### 4. å®ä½“æ“ä½œ - `POST /{entities}/{action-name}`

- **ç”¨é€”**: æ‰€æœ‰çš„å®ä½“æ“ä½œå¿…é¡»æœ‰æ˜ç¡®çš„æ“ä½œåç§°
- **å‘½åè§„èŒƒ**: æ“ä½œåä½¿ç”¨æ¸…æ™°çš„åŠ¨è¯æˆ–åŠ¨è¯çŸ­è¯­ï¼Œé‡‡ç”¨ kebab-case æ ¼å¼
- **ç¤ºä¾‹**:
  - `POST /api/models/batch-update` - æ‰¹é‡æ›´æ–°æ¨¡å‹
  - `POST /api/models/add-from-civitai` - ä» Civitai æ·»åŠ æ¨¡å‹
  - `POST /api/models/download-tasks/{hash}/action` - æ§åˆ¶ä¸‹è½½ä»»åŠ¡

### 5. è®¾è®¡ä¼˜åŠ¿

- **å¯é¢„æµ‹æ€§**: å¼€å‘è€…å¯ä»¥æ ¹æ® URL æ¨¡å¼é¢„æµ‹ API è¡Œä¸º
- **æ•°æ®æ•ˆç‡**: åˆ—è¡¨æŸ¥è¯¢è¿”å›ç®€æ´æ•°æ®ï¼Œè¯¦æƒ…æŸ¥è¯¢è¿”å›å®Œæ•´æ•°æ®
- **æ“ä½œæ˜ç¡®**: æ‰€æœ‰æ“ä½œéƒ½æœ‰æ˜ç¡®çš„è¯­ä¹‰ï¼Œé¿å…æ­§ä¹‰
- **æ‰©å±•æ€§**: æ–°æ“ä½œå¯ä»¥è½»æ¾æ·»åŠ è€Œä¸ç ´åç°æœ‰ API ç»“æ„

---

## 1. æ¨¡å‹ç®¡ç†ç±» (Model Management)

ç®¡ç† Stable Diffusion æ¨¡å‹çš„å¢åˆ æŸ¥æ”¹æ“ä½œå’Œä¸‹è½½ä»»åŠ¡ç®¡ç†ã€‚

### 1.1 æ¨¡å‹ CRUD æ“ä½œ

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° |
|------|------|----------|
| GET | `/api/models` | è·å–æ¨¡å‹åˆ—è¡¨ï¼ˆæ”¯æŒ JSON API æŸ¥è¯¢ï¼‰ |
| GET | `/api/models/{hash}` | è·å–æŒ‡å®šæ¨¡å‹å…ƒæ•°æ® |
| GET | `/api/models/{hash}/content` | ä¸‹è½½æ¨¡å‹æ–‡ä»¶å†…å®¹ |
| POST | `/api/models/batch-update` | æ‰¹é‡ä¿®æ”¹æ¨¡å‹å…ƒæ•°æ® |
| DELETE | `/api/models/{hash}` | åˆ é™¤æŒ‡å®šæ¨¡å‹ |
| DELETE | `/api/models` | æ‰¹é‡åˆ é™¤æ¨¡å‹ |

### 1.2 Civitai é›†æˆ

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° |
|------|------|----------|
| POST | `/api/models/add-from-civitai` | ä» Civitai æ·»åŠ æ–°æ¨¡å‹ |
| GET | `/api/models/add-from-civitai/{hash}` | SSE è¿½è¸ªä¸‹è½½è¿›åº¦ |
| POST | `/api/models/validate-civitai-url` | éªŒè¯ Civitai URL |
| GET | `/api/models/download-status/{hash}` | è·å–ä¸‹è½½çŠ¶æ€ |

### 1.3 ä¸‹è½½ä»»åŠ¡ç®¡ç†

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° |
|------|------|----------|
| GET | `/api/models/download-tasks` | è·å–æ‰€æœ‰ä¸‹è½½ä»»åŠ¡åˆ—è¡¨ |
| GET | `/api/models/download-tasks/{hash}` | è·å–æŒ‡å®šä¸‹è½½ä»»åŠ¡è¯¦æƒ… |
| POST | `/api/models/download-tasks/{hash}/action` | æ§åˆ¶ä¸‹è½½ä»»åŠ¡ï¼ˆæš‚åœ/æ¢å¤/å–æ¶ˆ/åˆ é™¤ï¼‰ |
| POST | `/api/models/download-tasks/batch-action` | æ‰¹é‡æ§åˆ¶ä¸‹è½½ä»»åŠ¡ |
| DELETE | `/api/models/download-tasks/completed` | æ¸…ç†å·²å®Œæˆçš„ä¸‹è½½ä»»åŠ¡ |
| POST | `/api/models/download-tasks/mock` | åˆ›å»ºæµ‹è¯•ä¸‹è½½ä»»åŠ¡ï¼ˆå¼€å‘æ¨¡å¼ï¼‰ |

ğŸ“– **è¯¦ç»†æ–‡æ¡£**: [Model Management API](./model-management.md)

---

## 2. ç³»ç»ŸåŠŸèƒ½ç±» (System Features)

æä¾›ç³»ç»ŸåŸºæœ¬ä¿¡æ¯æŸ¥è¯¢åŠŸèƒ½ã€‚

### API ç«¯ç‚¹

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° |
|------|------|----------|
| GET | `/` | è·å–æœåŠ¡åŸºæœ¬ä¿¡æ¯ |
| GET | `/health` | å¥åº·æ£€æŸ¥ç«¯ç‚¹ |

ğŸ“– **è¯¦ç»†æ–‡æ¡£**: [System Features API](./system-features.md)

---

## ğŸš§ å¼€å‘ä¸­çš„åŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½å·²è®¾è®¡ä½†å°šæœªå®ç°ï¼Œæ•¬è¯·æœŸå¾…ï¼š

### ä»»åŠ¡ç®¡ç†ç±» (Task Management)
> è®¡åˆ’åŠŸèƒ½ï¼šè°ƒåº¦ä¸»æœºèµ„æºï¼Œå®Œæˆå›¾åƒæ¸²æŸ“ä»»åŠ¡

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° | çŠ¶æ€ |
|------|------|----------|------|
| GET | `/api/tasks/queue` | SSE å®æ—¶æ¨é€ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€ | ğŸš§ è§„åˆ’ä¸­ |
| POST | `/api/tasks` | åˆ›å»ºæ–°ä»»åŠ¡ï¼ˆæ™ºèƒ½è°ƒåº¦ï¼‰ | ğŸš§ è§„åˆ’ä¸­ |
| DELETE | `/api/tasks` | å–æ¶ˆä»»åŠ¡åˆ—è¡¨ï¼ˆæ‰¹é‡å–æ¶ˆï¼‰ | ğŸš§ è§„åˆ’ä¸­ |
| PUT | `/api/tasks/promote` | æå‡ä»»åŠ¡åˆ—è¡¨æ‰§è¡Œä¼˜å…ˆçº§ï¼ˆæ‰¹é‡æå‡ï¼‰ | ï¿½ è§„åˆ’ä¸­ |

### å›¾åƒç®¡ç†ç±» (Image Management)
> è®¡åˆ’åŠŸèƒ½ï¼šç®¡ç†æ‰€æœ‰ç±»å‹çš„å›¾åƒå’Œå…ƒæ•°æ®ç³»ç»Ÿ

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° | çŠ¶æ€ |
|------|------|----------|------|
| GET | `/api/images` | è·å–å›¾åƒåˆ—è¡¨ï¼ˆæ”¯æŒ JSON API æŸ¥è¯¢ï¼‰ | ğŸš§ è§„åˆ’ä¸­ |
| GET | `/api/images/{hash}` | è·å–æŒ‡å®šå›¾åƒå…ƒæ•°æ® | ğŸš§ è§„åˆ’ä¸­ |
| GET | `/api/images/{hash}/content` | è·å–å›¾åƒæ–‡ä»¶å†…å®¹ | ğŸš§ è§„åˆ’ä¸­ |
| POST | `/api/images/{hash}` | ä¿®æ”¹å›¾åƒå…ƒæ•°æ® | ğŸš§ è§„åˆ’ä¸­ |
| POST | `/api/images` | æ‰¹é‡ä¿®æ”¹å›¾åƒå…ƒæ•°æ® | ğŸš§ è§„åˆ’ä¸­ |
| DELETE | `/api/images/{hash}` | åˆ é™¤æŒ‡å®šå›¾åƒ | ğŸš§ è§„åˆ’ä¸­ |
| DELETE | `/api/images` | æ‰¹é‡åˆ é™¤å›¾åƒ | ï¿½ è§„åˆ’ä¸­ |

### ç³»ç»Ÿé…ç½®ç±» (System Configuration)
> è®¡åˆ’åŠŸèƒ½ï¼šç³»ç»Ÿé…ç½®ç®¡ç†

| æ–¹æ³• | ç«¯ç‚¹ | åŠŸèƒ½æè¿° | çŠ¶æ€ |
|------|------|----------|------|
| GET | `/api/config` | è·å–ç³»ç»Ÿé…ç½®ï¼ˆéæ•æ„Ÿä¿¡æ¯ï¼‰ | ğŸš§ è§„åˆ’ä¸­ |
| GET | `/api/version` | è·å– API ç‰ˆæœ¬ä¿¡æ¯ | ğŸš§ è§„åˆ’ä¸­ |

---

## å¿«é€Ÿå¼€å§‹

### å¯åŠ¨ API æœåŠ¡
```bash
# ä½¿ç”¨ CLI å¯åŠ¨
sdh service start

# æˆ–ç›´æ¥è¿è¡Œ API
cd src
python -m api.main
```

### è®¿é—® API æ–‡æ¡£
- **äº¤äº’å¼æ–‡æ¡£**: http://localhost:8000/docs (Swagger UI)
- **ReDoc æ–‡æ¡£**: http://localhost:8000/redoc
- **å¥åº·æ£€æŸ¥**: http://localhost:8000/health

### åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹
```bash
# è·å–æ¨¡å‹åˆ—è¡¨
curl http://localhost:8000/api/models

# æ·»åŠ  Civitai æ¨¡å‹
curl -X POST http://localhost:8000/api/models/add-from-civitai \
  -H "Content-Type: application/json" \
  -d '{"model_id": "4201", "version_id": "130072"}'

# æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡
curl http://localhost:8000/api/models/download-tasks
```
